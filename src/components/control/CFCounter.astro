---
---

<script is:inline>
/**
 * CF-Counter 客戶端整合腳本 (V2.0 防重複版)
 * 功能：24 小時訪客鎖定、開發者調試模式、自動數據更新、列表頁批量獲取
 * 重要：使用全局標記防止重複初始化和重複計數
 */

// 防止腳本重複初始化
if (window.__cfCounterInitialized) {
    // 已經初始化過，不再執行
} else {
    window.__cfCounterInitialized = true;
    
    // 用於追蹤當前會話已計數的路徑
    window.__cfCountedPaths = window.__cfCountedPaths || new Set();

    async function updateCounterOnce() {
        const workerUrl = window.cfCounterUrl;
        const devMode = window.counterDevMode;
        if (!workerUrl) return;

        const path = window.location.pathname;
        
        // 檢查是否在當前會話中已經計數過這個路徑
        if (window.__cfCountedPaths.has(path)) {
            console.log('[CF-Counter] 此頁面已計數，只更新 UI:', path);
            // 只獲取數據更新 UI，不增加計數
            fetchAndUpdateUI(workerUrl, path, devMode);
            return;
        }
        
        // 標記為已計數
        window.__cfCountedPaths.add(path);
        
        const isPost = path.startsWith('/posts/') && path.length > 7;
        const currentSlug = isPost ? path.split('/').filter(Boolean).pop() : '__home__';

        // 24 小時訪客鎖定
        const lastVisitKey = `cf-visit-${path}`;
        const lastVisitTime = localStorage.getItem(lastVisitKey);
        const now = Date.now();
        const TWENTY_FOUR_HOURS = 24 * 60 * 60 * 1000;

        let isNewVisitor = false;
        
        if (devMode) {
            isNewVisitor = true;
            console.log(`[CF-Counter] 開發者模式：無視 24 小時限制`);
        } else {
            if (!lastVisitTime || (now - parseInt(lastVisitTime)) > TWENTY_FOUR_HOURS) {
                isNewVisitor = true;
                localStorage.setItem(lastVisitKey, now.toString());
            }
        }

        try {
            // 主請求：增加計數
            const mainParams = new URLSearchParams({
                path: path,
                mode: 'increment',
                new_visitor: isNewVisitor.toString(),
                dev: devMode.toString()
            });

            console.log('[CF-Counter] 發送計數請求:', path);

            fetch(`${workerUrl}?${mainParams.toString()}`)
                .then(res => res.json())
                .then(data => {
                    updateUIElements(currentSlug, data);
                })
                .catch(e => console.error('[CF-Counter] 計數請求失敗:', e));

            // 列表請求：獲取其他文章數據（不增加計數）
            fetchListCounters(workerUrl, devMode, currentSlug);

        } catch (error) {
            console.error('[CF-Counter] 錯誤:', error);
        }
    }

    function fetchAndUpdateUI(workerUrl, path, devMode) {
        const isPost = path.startsWith('/posts/') && path.length > 7;
        const currentSlug = isPost ? path.split('/').filter(Boolean).pop() : '__home__';

        const params = new URLSearchParams({
            path: path,
            mode: 'get',
            dev: devMode.toString()
        });

        fetch(`${workerUrl}?${params.toString()}`)
            .then(res => res.json())
            .then(data => {
                updateUIElements(currentSlug, data);
            })
            .catch(e => console.error('[CF-Counter] UI 更新失敗:', e));

        fetchListCounters(workerUrl, devMode, currentSlug);
    }

    function updateUIElements(currentSlug, data) {
        const postViewsEl = document.getElementById(`page-views-${currentSlug}`);
        const postVisitorsEl = document.getElementById(`page-visitors-${currentSlug}`);
        
        if (postViewsEl && data.views) postViewsEl.textContent = `${data.views} 次`;
        if (postVisitorsEl && data.visitors) postVisitorsEl.textContent = `${data.visitors} 人`;

        const siteViewsEl = document.getElementById('site-views');
        const siteVisitorsEl = document.getElementById('site-visitors');

        if (siteViewsEl && data.totalViews) siteViewsEl.textContent = data.totalViews;
        if (siteVisitorsEl && data.totalVisitors) siteVisitorsEl.textContent = data.totalVisitors;
    }

    function fetchListCounters(workerUrl, devMode, excludeSlug) {
        const listCounters = document.querySelectorAll('.cf-post-counter');
        if (listCounters.length === 0) return;

        const slugsToFetch = new Set();
        listCounters.forEach(el => {
            const slug = el.getAttribute('data-slug');
            if (slug && slug !== excludeSlug) {
                slugsToFetch.add(slug);
            }
        });

        slugsToFetch.forEach(slug => {
            const postPath = `/posts/${slug}/`;
            const listParams = new URLSearchParams({
                path: postPath,
                mode: 'get',
                dev: devMode.toString()
            });

            fetch(`${workerUrl}?${listParams.toString()}`)
                .then(res => res.json())
                .then(data => {
                    const pViews = document.getElementById(`page-views-${slug}`);
                    const pVisitors = document.getElementById(`page-visitors-${slug}`);
                    if (pViews && data.views) pViews.textContent = `${data.views} 次`;
                    if (pVisitors && data.visitors) pVisitors.textContent = `${data.visitors} 人`;
                })
                .catch(e => console.error(`[CF-Counter] 列表獲取失敗 ${slug}:`, e));
        });
    }

    // 將函數暴露到全局
    window.__cfUpdateCounter = updateCounterOnce;

    // 初始載入
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateCounterOnce, { once: true });
    } else {
        updateCounterOnce();
    }

    // Swup 頁面切換
    if (window.swup) {
        window.swup.hooks.on('page:view', updateCounterOnce);
    }

    // Astro View Transitions
    document.addEventListener('astro:page-load', function cfCounterOnPageLoad() {
        updateCounterOnce();
    });
}
</script>
